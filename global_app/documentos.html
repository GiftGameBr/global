<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enviar Documentos</title>
    <!-- CSS de solicitacoes.html -->
    <link href="assets/css/swap.css" rel="stylesheet" />
    <link href="assets/css/slick.css" rel="stylesheet" />
    <link href="assets/css/bootstrap.min.css" rel="stylesheet" />
    <link href="assets/css/style.css" rel="stylesheet" />
    <link href="assets/css/media_query.css" rel="stylesheet" />
    <link href="assets/css/custom-popup.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <!-- CSS de documentos.html (bootstrap já incluído acima) -->
    <style>
      /* Estilos personalizados de solicitacoes.html */
      .wrapper {
        padding: 48px 24px 96px;
      }
      .card-wrapper {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
      }
      @media (min-width: 480px) {
        .card-wrapper {
          grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
      }
      .custom-card {
        background-image: url("assets/images/card.jpg");
        background-size: cover;
        background-position: center;
        border: none;
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
        color: #fff;
        font-family: "Segoe UI", sans-serif;
        position: relative;
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        transform-style: preserve-3d;
        backdrop-filter: blur(5px);
        min-height: 180px;
        box-sizing: border-box;
      }
      .custom-card:hover {
        transform: scale(1.03);
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.7);
      }
      .custom-card * {
        max-width: 100%;
        box-sizing: border-box;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      .card-content {
        position: relative;
        z-index: 1;
      }
      .card-columns {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      @media (min-width: 480px) {
        .card-columns {
          flex-direction: row;
          justify-content: space-between;
        }
      }
      .card-column {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .card-column h4 {
        margin: 0;
        font-size: 12px;
        color: #ccc;
        text-transform: uppercase;
        border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        padding-bottom: 4px;
      }
      .card-column p {
        margin: 0;
        font-size: 15px;
        font-weight: 500;
        color: #f5f5f5;
      }
      .btn-edit {
        font-size: 13px;
        color: #00d4ff;
        text-decoration: underline;
        cursor: pointer;
        align-self: flex-start;
      }
      .custom-card button,
      .custom-card .btn,
      .custom-card h1,
      .custom-card h2,
      .custom-card h3,
      .custom-card h4,
      .custom-card span,
      .custom-card p {
        word-break: break-word;
        white-space: normal;
        text-align: left;
      }
      @media (max-width: 360px) {
        .custom-card {
          padding: 16px;
          font-size: 14px;
        }
        .custom-card .btn,
        .custom-card button {
          font-size: 13px;
          padding: 8px;
        }
      }
      .nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 999;
        background: #fff;
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
      }
      .card-header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 16px;
      }
      .card-logo img {
        height: 45px;
      }
      .card-title-valor h4 {
        margin: 0;
        font-size: 12px;
        color: #aaa;
        text-transform: uppercase;
      }
      .card-title-valor p {
        margin: 2px 0;
        font-size: 18px;
        color: #fff;
        font-weight: bold;
        background-color: #198754;
        padding: 4px 10px;
        border-radius: 5px;
      }
      .card-data p {
        margin: 0;
        font-size: 13px;
        color: #ccc;
        text-align: right;
      }
      @media (max-width: 480px) {
        .card-header-top {
          flex-direction: column;
          align-items: flex-start;
        }
        .card-data p {
          text-align: left;
        }
        .card-logo {
          margin-bottom: 4px;
        }
      }
      .container.mt-0 {
        margin-top: 0px !important;
        padding-top: 0 !important;
      }
    </style>
  </head>
  <body class="bg-dark text-white">
    <div class="site_content">
      <!-- Header (from solicitacoes.html) -->
      <header
        class="site_lr-spacer homeHeader-main d-flex justify-content-between align-items-center"
        id="top-navbar"
      >
        <div class="d-flex align-items-center">
          <a href="homeScreen.html">
            <img
              alt="homeLogo"
              class="nav-header"
              src="assets/images/svg/homeLogo.png"
              style="height: 30px"
            />
          </a>
        </div>

        <div class="homeHeader d-flex align-items-center gap-2">
          <span id="welcome-message">Carregando...</span>
          <a href="notification.html">
            <img
              alt="buttonNotification"
              src="assets/images/svg/buttonNotification.svg"
            />
          </a>
          <a
            aria-controls="offcanvasExample"
            data-bs-toggle="offcanvas"
            href="#offcanvasExample"
          >
            <img
              alt="buttonSettings"
              src="assets/images/svg/buttonSettings.svg"
            />
          </a>
        </div>
      </header>

      <section class="section-main section-main-ver">
        <div class="container py-4">
          <h3 class="mb-4">Página de Envio de Documentos</h3>
          <button
            class="btn btn-primary btn-upload-documento"
            data-cliente-id="EXEMPLO_CLIENTE_ID"
          >
            Enviar Documentos
          </button>
        </div>

        <!-- Modal de Upload de Documentos (from documentos.html) -->
        <div
          class="modal fade"
          id="uploadDocumentosModal"
          tabindex="-1"
          aria-labelledby="uploadDocumentosModalLabel"
          aria-hidden="true"
        >
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-dark text-white rounded-4 shadow">
              <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">
                  <iconify-icon
                    icon="ri:file-upload-line"
                    class="me-2 text-info"
                  ></iconify-icon>
                  Upload de Documentos
                </h5>
                <button
                  type="button"
                  class="btn-close btn-close-white"
                  data-bs-dismiss="modal"
                ></button>
              </div>
              <div class="modal-body">
                <!-- Form de upload: fica acima das abas -->
                <form
                  id="form-upload-documento"
                  style="display: none"
                  class="mb-4"
                >
                  <label for="inputFotoDocumento" class="form-label"
                    >Selecione a foto ou documento:</label
                  >
                  <div class="d-flex align-items-center gap-2">
                    <input
                      class="form-control"
                      type="file"
                      id="inputFotoDocumento"
                      accept="image/*"
                      required
                    />
                    <button
                      type="submit"
                      id="btnEnviarDocumento"
                      class="btn btn-success"
                      disabled
                    >
                      Enviar
                    </button>
                  </div>

                  <div
                    id="previewFotoDocumento"
                    class="text-center mt-3 mb-3"
                  ></div>

                  <div
                    class="progress mb-3"
                    style="height: 24px; display: none"
                    id="uploadProgressBarContainer"
                  >
                    <div
                      class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                      id="uploadProgressBar"
                      role="progressbar"
                      style="width: 0%"
                      aria-valuenow="0"
                      aria-valuemin="0"
                      aria-valuemax="100"
                    >
                      0%
                    </div>
                  </div>
                </form>

                <!-- Nav tabs -->
                <ul class="nav nav-tabs mb-3" id="tabDocumentos" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button
                      class="nav-link active"
                      id="pendentes-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#pendentes"
                      type="button"
                      role="tab"
                      aria-controls="pendentes"
                      aria-selected="true"
                    >
                      Pendentes
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button
                      class="nav-link"
                      id="enviados-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#enviados"
                      type="button"
                      role="tab"
                      aria-controls="enviados"
                      aria-selected="false"
                    >
                      Enviados
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button
                      class="nav-link"
                      id="aprovados-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#aprovados"
                      type="button"
                      role="tab"
                      aria-controls="aprovados"
                      aria-selected="false"
                    >
                      Aprovados
                    </button>
                  </li>
                </ul>

                <!-- Tab panes -->
                <div
                  class="tab-content"
                  id="tabDocumentosContent"
                  style="min-height: 300px"
                >
                  <!-- Pendentes -->
                  <div
                    class="tab-pane fade show active"
                    id="pendentes"
                    role="tabpanel"
                    aria-labelledby="pendentes-tab"
                  >
                    <ul id="listaPendentes" class="list-group mb-3"></ul>
                  </div>

                  <!-- Enviados -->
                  <div
                    class="tab-pane fade"
                    id="enviados"
                    role="tabpanel"
                    aria-labelledby="enviados-tab"
                  >
                    <ul id="listaEnviados" class="list-group"></ul>
                  </div>

                  <!-- Aprovados -->
                  <div
                    class="tab-pane fade"
                    id="aprovados"
                    role="tabpanel"
                    aria-labelledby="aprovados-tab"
                  >
                    <ul id="listaAprovados" class="list-group"></ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Setting Section (from solicitacoes.html) -->
      <section class="setting-section">
        <div
          aria-labelledby="offcanvasExampleLabel"
          class="offcanvas offcanvas-start"
          id="offcanvasExample"
          tabindex="-1"
        >
          <div class="offcanvas-header">
            <h2 class="offcanvas-title" id="offcanvasExampleLabel">Settings</h2>
            <button
              aria-label="Close"
              class="btn-close"
              data-bs-dismiss="offcanvas"
              type="button"
            ></button>
          </div>
          <div class="offcanvas-body">
            <a class="home-setting-icons-main" href="security.html">
              <div class="setting-opestion-main">
                <div class="setting-icons-main">
                  <img alt="security" src="assets/images/svg/security.svg" />
                </div>
                <h2 class="new-notification">Security</h2>
              </div>
              <img
                alt="right-half-arrow-black"
                class="setting-arrow"
                src="assets/images/svg/right-half-arrow-black.svg"
              />
            </a>
            <a class="home-setting-icons-main" href="marketingPreferences.html">
              <div class="setting-opestion-main">
                <div class="setting-icons-main">
                  <img
                    alt="marketing-icon"
                    src="assets/images/svg/marketing-icon.svg"
                  />
                </div>
                <h2 class="new-notification">Marketing Preferences</h2>
              </div>
              <img
                alt="right-half-arrow-black"
                class="setting-arrow"
                src="assets/images/svg/right-half-arrow-black.svg"
              />
            </a>
            <a class="home-setting-icons-main" href="notificationSettings.html">
              <div class="setting-opestion-main">
                <div class="setting-icons-main">
                  <img
                    alt="notificationOption"
                    src="assets/images/svg/notificationOption.svg"
                  />
                </div>
                <h2 class="new-notification">Notification Settings</h2>
              </div>
              <img
                alt="right-half-arrow-black"
                class="setting-arrow"
                src="assets/images/svg/right-half-arrow-black.svg"
              />
            </a>
            <a class="home-setting-icons-main" href="language.html">
              <div class="setting-opestion-main">
                <div class="setting-icons-main">
                  <img
                    alt="language-icon"
                    src="assets/images/svg/language-icon.svg"
                  />
                </div>
                <h2 class="new-notification">Language</h2>
              </div>
              <p class="version">English (US)</p>
              <img
                alt="right-half-arrow-black"
                class="setting-arrow"
                src="assets/images/svg/right-half-arrow-black.svg"
              />
            </a>
            <a class="home-setting-icons-main" href="faq.html">
              <div class="setting-opestion-main">
                <div class="setting-icons-main">
                  <img alt="faqs-icon" src="assets/images/svg/faqs-icon.svg" />
                </div>
                <h2 class="new-notification">FAQs</h2>
              </div>
              <img
                alt="right-half-arrow-black"
                class="setting-arrow"
                src="assets/images/svg/right-half-arrow-black.svg"
              />
            </a>
            <a class="home-setting-icons-main" href="dataPrivacy.html">
              <div class="setting-opestion-main">
                <div class="setting-icons-main">
                  <img
                    alt="dataPrivacy-icon"
                    src="assets/images/svg/dataPrivacy-icon.svg"
                  />
                </div>
                <h2 class="new-notification">Data &amp; Privacy Policy</h2>
              </div>
              <img
                alt="right-half-arrow-black"
                class="setting-arrow"
                src="assets/images/svg/right-half-arrow-black.svg"
              />
            </a>
            <a class="home-setting-icons-main" href="about.html">
              <div class="setting-opestion-main">
                <div class="setting-icons-main">
                  <img
                    alt="aboutVoice"
                    src="assets/images/svg/aboutVoice.svg"
                  />
                </div>
                <h2 class="new-notification">About WEvoice</h2>
              </div>
              <p class="version">v1.0.1</p>
              <img
                alt="right-half-arrow-black"
                class="setting-arrow"
                src="assets/images/svg/right-half-arrow-black.svg"
              />
            </a>
            <a class="home-setting-icons-main" href="feedback.html">
              <div class="setting-opestion-main">
                <div class="setting-icons-main">
                  <img
                    alt="feedback-icon"
                    src="assets/images/svg/feedback-icon.svg"
                  />
                </div>
                <h2 class="new-notification">Send Feedback</h2>
              </div>
              <img
                alt="right-half-arrow-black"
                class="setting-arrow"
                src="assets/images/svg/right-half-arrow-black.svg"
              />
            </a>
            <a class="home-setting-icons-main" href="contactUs.html">
              <div class="setting-opestion-main">
                <div class="setting-icons-main">
                  <img
                    alt="contactUs-icon"
                    src="assets/images/svg/contactUs-icon.svg"
                  />
                </div>
                <h2 class="new-notification">Contact Us</h2>
              </div>
              <img
                alt="right-half-arrow-black"
                class="setting-arrow"
                src="assets/images/svg/right-half-arrow-black.svg"
              />
            </a>
            <a class="home-setting-icons-main" href="inviteFriends.html">
              <div class="setting-opestion-main">
                <div class="setting-icons-main">
                  <img
                    alt="inviteFriend-icon"
                    src="assets/images/svg/inviteFriend-icon.svg"
                  />
                </div>
                <h2 class="new-notification">Invite Friends</h2>
              </div>
              <img
                alt="right-half-arrow-black"
                class="setting-arrow"
                src="assets/images/svg/right-half-arrow-black.svg"
              />
            </a>
            <a class="home-setting-icons-main" href="deleteDeactivate.html">
              <div class="setting-opestion-main">
                <div class="setting-icons-main setting-icons-main2">
                  <img
                    alt="close-setting-icon"
                    src="assets/images/svg/close-setting-icon.svg"
                  />
                </div>
                <h2 class="new-notification">Delete or Deactivate Account</h2>
              </div>
              <img
                alt="right-half-arrow-black"
                class="setting-arrow"
                src="assets/images/svg/right-half-arrow-black.svg"
              />
            </a>
            <a class="home-setting-icons-main mb-0" href="logout.html">
              <div class="setting-opestion-main">
                <div class="setting-icons-main setting-icons-main2">
                  <img
                    alt="logOut-icon"
                    src="assets/images/svg/logOut-icon.svg"
                  />
                </div>
                <h2 class="new-notification">Logout</h2>
              </div>
              <img
                alt="right-half-arrow-black"
                class="setting-arrow"
                src="assets/images/svg/right-half-arrow-black.svg"
              />
            </a>
          </div>
        </div>
      </section>
    </div>

    <!-- Scripts de documentos.html -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="assets/js/firebase-init.js"></script>
    <script>
      // Lista fixa de documentos
      const listaDocumentosFixos = [
        "CND - Certidão Negativa de Débitos(Tributos Federais e Dívida Ativa da União)",
        "CNH - Proponente",
        "CNH - Cônjuge",
        "Certidão de Nascimento/Casamento",
        "Declaração de IRPF",
        "Recibo de IRPF",
        "Declaração CMN - Declaração de Renegociações por Resoluções do CMN",
        "Certificado de Cadastro do Imóvel Rural (CCIR) - Imóvel Beneficiado",
        "Certidão Negativa de Débitos do Imóvel Rural ou Prova de Pagamento/Quitação do ITR",
        "Certidão de Inteiro Teor do Objeto da Cessão (Validade de até 1 ano)",
        "Certidão de Ônus do Imóvel Objeto da Cessão",
        "Licença Ambiental de Operação (LO)",
        "Roteiro de Acesso ao Imóvel",
        "Cadastro Ambiental Rural (CAR) - Documento de Inscrição",
        "Cadastro Ambiental Rural (CAR) - Demonstrativo de Situação",
        "Documentos de Cessão (Contratos e/ou Anuência) - Crédito Rural",
        "Autorização para Supressão de Vegetação (ASV)",
        "Outorga d'Água",
        "KML da Área Total do Imóvel",
        "KML da Área Beneficiada no Custeio",
      ];

      // Elementos do DOM
      const listaPendentes = document.getElementById("listaPendentes");
      const listaEnviados = document.getElementById("listaEnviados");
      const listaAprovados = document.getElementById("listaAprovados");

      const formUpload = document.getElementById("form-upload-documento");
      const fileInput = document.getElementById("inputFotoDocumento");
      const btnEnviar = document.getElementById("btnEnviarDocumento");
      const previewDiv = document.getElementById("previewFotoDocumento");
      const progressContainer = document.getElementById(
        "uploadProgressBarContainer"
      );
      const progressBar = document.getElementById("uploadProgressBar");

      let clienteIdSelecionado = null;
      let tipoDocumentoSelecionado = null;

      // Ao clicar no botão Documentos, abrir modal e carregar listas
      document.addEventListener("click", async (e) => {
        if (e.target && e.target.classList.contains("btn-upload-documento")) {
          clienteIdSelecionado = e.target.getAttribute("data-cliente-id");
          tipoDocumentoSelecionado = null;

          limparTudo();
          await carregarDocumentosCliente(clienteIdSelecionado);

          const modalEl = document.getElementById("uploadDocumentosModal");
          const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
          modal.show();

          // Força abrir aba Pendentes
          const tabTrigger = new bootstrap.Tab(
            document.querySelector("#pendentes-tab")
          );
          tabTrigger.show();
        }
      });

      // Limpar interface antes de carregar
      function limparTudo() {
        listaPendentes.innerHTML = "";
        listaEnviados.innerHTML = "";
        listaAprovados.innerHTML = "";
        previewDiv.innerHTML = "";
        fileInput.value = "";
        btnEnviar.disabled = true;
        btnEnviar.textContent = "Enviar";
        progressContainer.style.display = "none";
        progressBar.style.width = "0%";
        progressBar.textContent = "0%";
        formUpload.style.display = "none";
      }

      // Carrega documentos do cliente do Firestore e separa pendentes, enviados e aprovados
      async function carregarDocumentosCliente(clienteId) {
        if (!clienteId) return;

        try {
          const docSnap = await firebase
            .firestore()
            .collection("clientes")
            .doc(clienteId)
            .get();
          const data = docSnap.exists ? docSnap.data() : {};
          const documentos = data.documentos || {};

          // Separar documentos
          const enviados = [];
          const aprovados = [];

          for (const docName of Object.keys(documentos)) {
            const doc = documentos[docName];
            if (doc && doc.url) {
              if (doc.status === "aprovado")
                aprovados.push({ tipo: docName, url: doc.url });
              else enviados.push({ tipo: docName, url: doc.url });
            }
          }

          // Pendentes = lista fixa - docs enviados e aprovados
          const docsPendentes = listaDocumentosFixos.filter(
            (docName) =>
              !enviados.some((e) => e.tipo === docName) &&
              !aprovados.some((a) => a.tipo === docName)
          );

          mostrarPendentes(docsPendentes);
          mostrarEnviados(enviados);
          mostrarAprovados(aprovados);
        } catch (error) {
          alert("Erro ao carregar documentos: " + error.message);
        }
      }

      // Mostrar pendentes, clicáveis para iniciar upload
      function mostrarPendentes(pendentes) {
        listaPendentes.innerHTML = "";
        if (!pendentes.length) {
          listaPendentes.innerHTML =
            '<li class="list-group-item text-center">Nenhum documento pendente</li>';
          formUpload.style.display = "none";
          return;
        }
        pendentes.forEach((tipo) => {
          const li = document.createElement("li");
          li.className = "list-group-item list-group-item-action";
          li.textContent = tipo;
          li.style.cursor = "pointer";
          li.onclick = () => {
            tipoDocumentoSelecionado = tipo;
            mostrarFormUpload(tipo);
          };
          listaPendentes.appendChild(li);
        });
      }

      // Mostrar enviados com botões Aprovar e Desaprovar
      function mostrarEnviados(enviados) {
        listaEnviados.innerHTML = "";
        if (!enviados.length) {
          listaEnviados.innerHTML =
            '<li class="list-group-item text-center">Nenhum documento enviado</li>';
          return;
        }
        enviados.forEach(({ tipo, url }) => {
          const li = document.createElement("li");
          li.className =
            "list-group-item d-flex justify-content-between align-items-center";
          li.innerHTML = `
      <span>${tipo}</span>
      <div>
        <a href="${url}" target="_blank" class="btn btn-outline-dark btn-sm me-2">Ver</a>
        <button class="btn btn-success btn-sm btn-aprovar-doc" data-tipo="${tipo}">Aprovar</button>
        <button class="btn btn-danger btn-sm btn-desaprovar-doc" data-tipo="${tipo}" data-url="${url}">Desaprovar</button>
      </div>
    `;
          listaEnviados.appendChild(li);
        });
      }

      // Mostrar aprovados com botão Excluir
      function mostrarAprovados(aprovados) {
        listaAprovados.innerHTML = "";
        if (!aprovados.length) {
          listaAprovados.innerHTML =
            '<li class="list-group-item text-center">Nenhum documento aprovado</li>';
          return;
        }
        aprovados.forEach(({ tipo, url }) => {
          const li = document.createElement("li");
          li.className =
            "list-group-item d-flex justify-content-between align-items-center bg-success text-white";
          li.innerHTML = `
      <span>${tipo}</span>
      <div>
        <a href="${url}" target="_blank" class="btn btn-outline-light btn-sm me-2">Ver</a>
        <button class="btn btn-danger btn-sm btn-excluir-doc" data-tipo="${tipo}" data-url="${url}">Excluir</button>
      </div>
    `;
          listaAprovados.appendChild(li);
        });
      }

      // Mostrar formulário upload na aba Pendentes após selecionar um documento
      function mostrarFormUpload(tipo) {
        formUpload.style.display = "block";
        previewDiv.innerHTML = "";
        btnEnviar.disabled = true;
        fileInput.value = "";
        previewDiv.innerHTML = `<p>Enviando documento: <strong>${tipo}</strong></p>`;
      }

      // Habilitar botão enviar só se tiver arquivo selecionado
      fileInput.addEventListener("change", () => {
        btnEnviar.disabled = !fileInput.files.length;
      });

      // Envio do documento para Storage e Firestore
      formUpload.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!tipoDocumentoSelecionado)
          return alert("Selecione um documento pendente para enviar.");
        if (!fileInput.files.length)
          return alert("Selecione um arquivo para enviar.");
        if (!clienteIdSelecionado) return alert("Cliente não definido.");

        btnEnviar.disabled = true;
        btnEnviar.textContent = "Enviando...";
        progressContainer.style.display = "block";
        progressBar.style.width = "0%";
        progressBar.textContent = "0%";
        fileInput.disabled = true;

        try {
          const file = fileInput.files[0];
          const storageRef = storage.ref(
            `documentos/${clienteIdSelecionado}/${Date.now()}-${file.name}`
          );
          const uploadTask = storageRef.put(file);

          uploadTask.on(
            "state_changed",
            (snapshot) => {
              const progress = Math.round(
                (snapshot.bytesTransferred / snapshot.totalBytes) * 100
              );
              progressBar.style.width = progress + "%";
              progressBar.textContent = progress + "%";
            },
            (error) => {
              alert("Erro no upload: " + error.message);
              progressContainer.style.display = "none";
              btnEnviar.disabled = false;
              btnEnviar.textContent = "Enviar";
              fileInput.disabled = false;
            },
            async () => {
              const downloadURL =
                await uploadTask.snapshot.ref.getDownloadURL();

              await firebase
                .firestore()
                .collection("clientes")
                .doc(clienteIdSelecionado)
                .set(
                  {
                    documentos: {
                      [tipoDocumentoSelecionado]: {
                        url: downloadURL,
                        status: "enviado",
                      },
                    },
                  },
                  { merge: true }
                );

              alert("Documento enviado com sucesso!");
              await carregarDocumentosCliente(clienteIdSelecionado);

              // Limpa e esconde o formulário
              fileInput.value = "";
              btnEnviar.disabled = true;
              btnEnviar.textContent = "Enviar";
              formUpload.style.display = "none";
              previewDiv.innerHTML = "";

              progressContainer.style.display = "none";
              fileInput.disabled = false;
            }
          );
        } catch (error) {
          alert("Erro ao enviar documento: " + error.message);
          progressContainer.style.display = "none";
          btnEnviar.disabled = false;
          btnEnviar.textContent = "Enviar";
          fileInput.disabled = false;
        }
      });

      // Botões Aprovar e Desaprovar na aba enviados
      listaEnviados.addEventListener("click", async (e) => {
        if (e.target.classList.contains("btn-aprovar-doc")) {
          const tipo = e.target.getAttribute("data-tipo");
          await aprovarDocumento(tipo);
        } else if (e.target.classList.contains("btn-desaprovar-doc")) {
          const tipo = e.target.getAttribute("data-tipo");
          const url = e.target.getAttribute("data-url");
          await desaprovarDocumento(tipo, url);
        }
      });

      // Botão excluir na aba aprovados
      listaAprovados.addEventListener("click", async (e) => {
        if (e.target.classList.contains("btn-excluir-doc")) {
          const tipo = e.target.getAttribute("data-tipo");
          const url = e.target.getAttribute("data-url");
          if (!confirm(`Tem certeza que deseja excluir o documento "${tipo}"?`))
            return;
          try {
            await firebase
              .firestore()
              .collection("clientes")
              .doc(clienteIdSelecionado)
              .update({
                [`documentos.${tipo}`]: firebase.firestore.FieldValue.delete(),
              });

            if (url) {
              const storageRef = storage.refFromURL(url);
              await storageRef.delete();
            }

            alert(`Documento "${tipo}" excluído com sucesso!`);
            await carregarDocumentosCliente(clienteIdSelecionado);
          } catch (error) {
            alert("Erro ao excluir documento: " + error.message);
          }
        }
      });

      // Aprovar documento
      async function aprovarDocumento(tipo) {
        if (!clienteIdSelecionado) return alert("Cliente não definido.");
        try {
          await firebase
            .firestore()
            .collection("clientes")
            .doc(clienteIdSelecionado)
            .update({
              [`documentos.${tipo}.status`]: "aprovado",
            });
          alert(`Documento "${tipo}" aprovado.`);
          await carregarDocumentosCliente(clienteIdSelecionado);
        } catch (error) {
          alert("Erro ao aprovar documento: " + error.message);
        }
      }

      // Desaprovar documento (exclui e volta para pendentes)
      async function desaprovarDocumento(tipo, url) {
        if (!clienteIdSelecionado) return alert("Cliente não definido.");
        if (
          !confirm(
            `Tem certeza que deseja desaprovar e excluir o documento "${tipo}"?`
          )
        )
          return;

        try {
          await firebase
            .firestore()
            .collection("clientes")
            .doc(clienteIdSelecionado)
            .update({
              [`documentos.${tipo}`]: firebase.firestore.FieldValue.delete(),
            });

          if (url) {
            const storageRef = storage.refFromURL(url);
            await storageRef.delete();
          }

          alert(`Documento "${tipo}" desaprovado e excluído.`);
          await carregarDocumentosCliente(clienteIdSelecionado);
        } catch (error) {
          alert("Erro ao desaprovar documento: " + error.message);
        }
      }
    </script>
    <!-- Bootstrap JS (bundle includes Popper) -->
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <!-- Iconify (para os ícones) -->
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
  </body>
</html>
